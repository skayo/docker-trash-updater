# Steps:
# 1. Check for new release
# 2. Update Dockerfile with new version
# 3. Create git tag for version
# 4. Push changes to tag and main branch

name: Update Workflow

on:
  # Schedule every 15 minutes
  schedule:
    - cron: '15 * * * *'

  # Also allow manual dispatch
  workflow_dispatch: null

jobs:
  update-on-new-release:
    name: Update Repo On New Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ⤵
        uses: actions/checkout@v3.0.0

      - name: Fetch latest version 🌐
        id: version-fetch
        run: |
          curl -sL -X GET https://api.github.com/repos/rcdailey/trash-updater/releases/latest | \
            jq -r '. | .tag_name' > ./version

          echo ::set-output name=version::$(< ./version tr -d '\n')

      - name: Check if version was updated 🧐
        id: version-check
        run: |
          echo ::set-output name=updated::$([ -z "`git status --porcelain ./version`" ] && echo "no" || echo "yes")

      - if: steps.version-check.outputs.updated == 'yes'
        name: Generate dockerfile for version "${{ steps.version-fetch.outputs.version }}" 🖨
        uses: mshick/fast-envsubst@v1
        with:
          in-file: ./tmpl.Dockerfile
          out-file: ./Dockerfile
        env:
          VERSION: ${{ steps.version-fetch.outputs.version }}

      - if: steps.version-check.outputs.updated == 'yes'
        name: Push new dockerfile and version tag ⤴
        run: |
          git config --global user.name 'Señor Bob'
          git config --global user.email 'bot@skayo.dev'
          git add -A
          git commit -F ./version
          git tag -a "${{ steps.version-fetch.outputs.version }}" -F ./version
          git push -q --follow-tags -u origin main
